 <VirtualHost *:80>
	
	#ServerName techolaf.com
	#ServerAlias www.techolaf.com

	ServerName temp.com
	ServerAlias www.temp.com

	ServerAdmin admin@temp.com
	DocumentRoot /usr/local/apache2/techolaf
	
	<Directory "/usr/local/apache2/techolaf">
		Order allow,deny
		AllowOverride All
		Allow from all
		Require all granted
	</Directory>

    #Load the SSL module that is needed to terminate SSL on Apache
    #LoadModule ssl_module modules/mod_ssl.so

    # chen
    LoadModule rewrite_module modules/mod_rewrite.so


     # chen
     SSLCertificateFile /usr/local/apache2/conf/server.crt
     SSLCertificateKeyFile /usr/local/apache2/conf/server.key

    #This directive toggles the usage of the SSL/TLS Protocol Engine for proxy. Without this you cannot use HTTPS URL as your Origin Server
    SSLProxyEngine on

    # To prevent SSL Offloading
    # Set the X-Forwarded-Proto to be https for your Origin Server to understand that this request is made over HTTPS #https://httpd.apache.org/docs/2.2/mod/mod_headers.html#requestheader.
    RequestHeader set X-Forwarded-Proto "https"
    RequestHeader set X-Forwarded-Port "443"	

    #ErrorLog logs/techolaf-error.log
    ErrorLog logs/techolaf-access.log
    CustomLog logs/techolaf-access.log combined

    # The ProxyPass directive specifies the mapping of incoming requests to the backend server (or a cluster of servers known as a Balancer group).
    # It proxies the requests only with matching URI "/blog"

#    ProxyPass /sf/getProducts https://sbppi-nova-lumos.cs89.force.com/api/services/apexrest/PPGetProducts
#    ProxyPassReverse /sf/getProducts https://sbppi-nova-lumos.cs89.force.com/api/services/apexrest/PPGetProducts

#    ProxyPass /sf/notification https://sbppi-nova-lumos.cs89.force.com/api/services/apexrest/PPnotification
#    ProxyPassReverse /sf/notification https://sbppi-nova-lumos.cs89.force.com/api/services/apexrest/PPnotification


    ProxyPass /PPapi/PPGetProducts https://sbppi-nova-lumos.cs89.force.com/api/services/apexrest/PPGetProducts
    ProxyPassReverse /PPapi/PPGetProducts https://sbppi-nova-lumos.cs89.force.com/api/services/apexrest/PPGetProducts

    ProxyPass /PPapi/PPnotification https://sbppi-nova-lumos.cs89.force.com/api/services/apexrest/PPnotification
    ProxyPassReverse /PPapi/PPnotification https://sbppi-nova-lumos.cs89.force.com/api/services/apexrest/PPnotification

    RewriteEngine  on
    LogLevel alert rewrite:trace7

    RewriteMap sps2url "prg:/usr/local/apache2/conf/lms-mapping.py"
    # RewriteCond %{REQUEST_URI} "/fota/100"
    # RewriteRule ^/fota/([0-9]+)$ "https://lms-firmware-repo.s3-eu-west-1.amazonaws.com/${sps2url:$1}"  [P]
    RewriteRule ^/(.*)$ "https://lms-firmware-repo.s3-eu-west-1.amazonaws.com/$1"  [P]
    ProxyPassReverse "/fota/" "https://lms-firmware-repo/fota/"

# exmaple:
# real file download (key removed)
# https://lms-firmware-repo.s3-eu-west-1.amazonaws.com/sps/job-26876114-1255291-idu-05.78/idu-fw-05.78.bin?AWSAccessKeyId=XXXXXXXXXXXXXXXXX&Expires=1613397335&Signature=83iaIecpPZinmYX2QRXp2stWEvo%3D

# same url via proxy (key removed)
# http://52.16.47.21:90/sps/job-91135514-3758279-battery_bms-BMS_HA_D04/battery_bms-fw-BMS_HA_D04.bin?AWSAccessKeyId=XXXXXXXXXXXXXXXXX&Expires=1613465122&Signature=Un0feWMh79wCJ1%2B61yeJqsahYUs%3D

</VirtualHost>

